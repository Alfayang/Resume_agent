<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>信件AI降重助手</title>
  <style>
    body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; }
    #sidebar { width: 450px; background: #232323; color: #fff; padding: 24px; display: flex; flex-direction: column; }
    #chat { flex: 1; overflow-y: auto; margin-bottom: 12px; }
    .msg { padding: 12px; margin: 8px 0; border-radius: 8px; }
    .user { background: #333; }
    .ai { background: #282b36; }
    #input { width: 100%; height: 60px; resize: none; }
    button { width: 100%; height: 36px; background: #1890ff; color: #fff; border: none; border-radius: 4px; }
    #main { flex: 1; padding: 24px; background: #fafbfc; overflow:auto;}
    #report-box { background: #fff; min-height: 90vh; border-radius: 8px; padding: 24px; box-shadow: 0 2px 8px #0001; }
    .section-title { color: #1890ff; font-size: 20px; margin-top: 0; }
    .critique { color: #c66; margin-top: 16px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <div id="sidebar">
    <h2>AI降重助手</h2>
    <div id="chat">
      <div class="msg ai">欢迎使用AI降重助手，请输入你的信件。</div>
    </div>
    <textarea id="input" placeholder="输入你的信件"></textarea>
    <button onclick="send()">发送</button>
  </div>
  <div id="main">
    <h2>润色结果</h2>
    <div id="report-box">这里会显示AI为你润色后的信件</div>
  </div>
  <script>
    function escapeHTML(str) {
      if (!str) return "";
      return str.replace(/[<>&"]/g, function (c) {
        return {'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'}[c];
      });
    }
    function send() {
      var input = document.getElementById('input');
      var msg = input.value.trim();
      if(!msg) return;
      var chat = document.getElementById('chat');
      chat.innerHTML += '<div class="msg user">'+escapeHTML(msg)+'</div>';
      input.value = '';
      chat.scrollTop = chat.scrollHeight;
      chat.innerHTML += '<div class="msg ai" id="loading">AI 正在生成，请稍候...</div>';
      chat.scrollTop = chat.scrollHeight;
      // ========== 只取纯文本 ==========
      fetch('http://localhost:8002/generate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_input: msg})
      })
      .then(r => r.text()) // <<<<<< 改成 .text() 只取字符串
      .then(mainText => {
        document.getElementById('loading').remove();
        // 只返回润色内容
        chat.innerHTML += '<div class="msg ai"><b>AI润色结果：</b><br>' + escapeHTML(mainText) + '</div>';
        chat.scrollTop = chat.scrollHeight;
        document.getElementById('report-box').innerHTML =
          '<div><span class="section-title">润色结果：</span>' +
          marked.parse(mainText) +
          '</div>';
      })
      .catch(e => {
        document.getElementById('loading').remove();
        chat.innerHTML += '<div class="msg ai">请求失败，请检查后端服务！</div>';
        chat.scrollTop = chat.scrollHeight;
        document.getElementById('report-box').innerHTML = "请求失败，请检查后端服务！";
      });
    }
  </script>
</body>
</html>
